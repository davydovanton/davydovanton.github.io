<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Seed файл и вы &middot; Anton Davydov
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/base.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- SEO -->
  

  <link rel="author" href="https://plus.google.com/u/0/104253015484296728880"/>
</head>


  <body>
    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>Personal page with my blog where I'll write about ruby, my ideas and technologies which I love<br><a href="https://twitter.com/anton_davydov" target="_blank">@anton_davydov</a></p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="http://davydovanton.com/contacts/">Contacts</a>
    <a class="sidebar-nav-item" href="http://davydovanton.com/tags/">All Posts</a>
    <a class="sidebar-nav-item" href="https://github.com/davydovanton">GitHub</a>
    <a class="sidebar-nav-item" href="https://twitter.com/anton_davydov">Twitter</a>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2021. All rights reserved.
    </p>
  </div>
</div>

    <div class="yandex_metrica">
<!-- Yandex.Metrika counter --><script type="text/javascript">var yaParams = {/*Здесь параметры визита*/};</script><script type="text/javascript">(function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter23652886 = new Ya.Metrika({id:23652886, webvisor:true, clickmap:true, trackLinks:true, accurateTrackBounce:true, trackHash:true,params:window.yaParams||{ }}); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script><noscript><div><img src="//mc.yandex.ru/watch/23652886" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Anton Davydov</a>
            <small></small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Seed файл и вы</h1>
  <span class="post-date">10 Mar 2014</span>
  <p>Совсем недавно, на работе, потребовалось мне заполнить новый проект данными для дальнейшего тестирования и разработки. Конечно же, данные должны быть в любом виде, и первое, о чем я подумал, был seed файл, поэтому сегодня мы поговорим именно о нем. Как всем известно, данный файл служит для генерации данных в рельсовых приложениях. Вы пишите скрипт, выполняете <code class="highlighter-rouge">rake db:seed</code> и радуетесь жизни. В моем случае данные были типовыми, а именно, нужно было сгенерировать пользователей, посты и комментарии к этим постам. Я думаю все прекрасно понимают, как все взаимосвязанно, поэтому на этом останавливаться не вижу особого смысла.</p>

<p>Обычная практика многих людей - задать одинаковые данные для всех типов данных и наплодить их с десяток. Смотрится это обычно как-то так:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">user</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">name:  </span><span class="s1">'Jon'</span>
  <span class="ss">email: </span><span class="s1">'my@email.org'</span>
  <span class="ss">password: </span><span class="s1">'12345678'</span><span class="p">,</span>
  <span class="ss">password_confirmation: </span><span class="s1">'12345678'</span>  
  <span class="p">}</span>

<span class="n">post</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">title:  </span><span class="s1">'My Post'</span>
  <span class="ss">body:   </span><span class="s1">'My body'</span>
  <span class="p">}</span>

<span class="n">comment</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">body: </span><span class="s1">'comment'</span> <span class="p">}</span>

<span class="mi">10</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span>
  <span class="n">my_user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">my_post</span> <span class="o">=</span> <span class="n">my_user</span><span class="p">.</span><span class="nf">create_post</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
  <span class="n">my_post</span><span class="p">.</span><span class="nf">create_comment</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure>

<p>Но согласитесь, это скучно, банально и задевает чувство прекрасного. Поэтому давайте плюнем на все и развлечемся, создав свой собственный, изменяющийся из раза в раз мир :)</p>

<p><em><strong>ATTENTION</strong>: далее будет много рандома, благодаря которому поддерживать все это или искать ошибки становится все сложнее и сложнее. Поэтому, использование генераторов, основанных на рандоме не рекомендуется для продакшена. В крайнем, случае использовать аккуратно и с умом.</em></p>

<p>Для того, чтобы наш воображаемый мир существовал, нам, естественно, нужны пользователи. И наша цель - создать абсолютно разных пользователей, не похожих друг на друга. Конечно же, первое, что всплывает в голову - замечательный гем <a href="https://github.com/stympy/faker">faker</a>, который поможет нам генерировать произвольные имена и почтовые адресса для наших пользователей. Но при всем при этом, не будем забывать про нашего админа. Так же, давайте зададим рандомное количество записей в интервале от 18 до 25 штук (числа, как вы догадались, могут быть абсолютно любые):</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">user</span> <span class="o">=</span> <span class="p">{</span>
  <span class="ss">name:  </span><span class="n">admin</span>
  <span class="ss">email: </span><span class="n">admin</span><span class="vi">@my_app</span><span class="p">.</span><span class="nf">com</span>
  <span class="ss">password: </span><span class="s1">'12345678'</span><span class="p">,</span>
  <span class="ss">password_confirmation: </span><span class="s1">'12345678'</span>  
  <span class="p">}</span>

<span class="n">rnd</span> <span class="o">=</span> <span class="no">Random</span><span class="p">.</span><span class="nf">new</span>
<span class="n">user_count</span> <span class="o">=</span> <span class="n">rnd</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="mi">18</span><span class="o">..</span><span class="mi">23</span><span class="p">)</span>
<span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

<span class="n">user_count</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span>
  <span class="n">user</span><span class="p">[</span><span class="ss">:name</span><span class="p">]</span>  <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="p">.</span><span class="nf">name</span>
  <span class="n">user</span><span class="p">[</span><span class="ss">:email</span><span class="p">]</span> <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">email</span>  
  <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure>

<p>Cобственно я уверен, faker поможет вам сгенерировать почти любую информацию, стоит только открыть доки. Ну а если вам не угодил этот гем, то существует достаточно <a href="https://www.ruby-toolbox.com/categories/random_data_generation">много</a> других data генераторов.</p>

<p>Не думаю, что тут что-то было сложно, поэтому пререйдем к постам. Сказать по правде, в нашем проекте посты состояли из строго заданных кусков html-a, поэтому тут ничего не оставалось, кроме как делать в лоб. Единственный момент, мы будем выбирать произвольно пользователя, чтобы от его имени создавать наш пост:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">posts</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="ss">title:  </span><span class="s1">'My first Post'</span>
    <span class="ss">body:   </span><span class="s1">'My body'</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="ss">title:  </span><span class="s1">'My second Post'</span>
    <span class="ss">body:   </span><span class="s1">'My body'</span>    
  <span class="p">},</span>
  <span class="c1"># Еще какое-то количество данных для постов ...</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">rnd_user</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">rnd</span><span class="p">)</span>
  <span class="n">random_user_id</span> <span class="o">=</span> <span class="n">rnd</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="mi">1</span><span class="o">..</span><span class="p">(</span><span class="n">count</span><span class="p">))</span>
  <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">random_user_id</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">posts</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span>
  <span class="n">rand_user</span> <span class="o">=</span> <span class="n">rnd_user</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rnd</span>

  <span class="n">post</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand_user</span><span class="p">.</span><span class="nf">id</span>
  <span class="n">created_post</span> <span class="o">=</span> <span class="n">rand_user</span><span class="p">.</span><span class="nf">create_post</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
<span class="k">end</span></code></pre></figure>

<p>Настало время самого интересного и забавного, комментарии. В данном проекте мы использовали гем <a href="https://github.com/elight/acts_as_commentable_with_threading">acts_as_commentable_with_threading</a>. Он содержит 2ух уровневую структуру комментариев, поэтому работы нам немного прибавилось. Чтобы создать комментарий, нам необходимы 3 значения: пост, где будет этот комментарий, пользователь, оставивший комментарий, и непосредственно сам текст комментария. Смотрится все это примерно так:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">post</span><span class="p">.</span><span class="nf">build_comment</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span></code></pre></figure>

<p>Ну а для “подкомментария” нам так же необходимо знать родительский комментарий, от которого ветка и пойдет, т.е. создание подобного комментария будет выглядеть примерно так:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">child_comment</span> <span class="o">=</span> <span class="n">post</span><span class="p">.</span><span class="nf">build_comment</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
<span class="n">child_comment</span><span class="p">.</span><span class="nf">move_to_child_of</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span></code></pre></figure>

<p>А теперь давайте создадим от 10 до 21 главных комментариев и до 9ти дочерних для каждого главного, при этом каждый комментарий будет оставлять рандомный пользователь:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">posts</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span>
  <span class="n">rand_user</span> <span class="o">=</span> <span class="n">rnd_user</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rnd</span>

  <span class="n">post</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand_user</span><span class="p">.</span><span class="nf">id</span>
  <span class="n">created_post</span> <span class="o">=</span> <span class="n">rand_user</span><span class="p">.</span><span class="nf">create_post</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>

  <span class="n">rnd</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="mi">10</span><span class="o">..</span><span class="mi">21</span><span class="p">).</span><span class="nf">times</span> <span class="k">do</span>
    <span class="n">rand_user</span> <span class="o">=</span> <span class="n">rnd_user</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rnd</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">created_post</span><span class="p">.</span><span class="nf">build_comment</span><span class="p">(</span><span class="n">rand_user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="s1">'Comment body'</span><span class="p">)</span>
    <span class="n">comment</span><span class="p">.</span><span class="nf">save!</span>

    <span class="n">rnd</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="mi">9</span><span class="p">).</span><span class="nf">times</span> <span class="k">do</span>
      <span class="n">rand_user</span> <span class="o">=</span> <span class="n">rnd_user</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rnd</span>
      <span class="n">child_comment</span> <span class="o">=</span> <span class="n">created_post</span><span class="p">.</span><span class="nf">build_comment</span><span class="p">(</span><span class="n">rand_user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="s1">'Comment body'</span><span class="p">)</span>
      <span class="n">child_comment</span><span class="p">.</span><span class="nf">save!</span>
      <span class="n">child_comment</span><span class="p">.</span><span class="nf">move_to_child_of</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Хм, рандомное количество комментариев мы сделали, пользователей тоже разных назначили, но вот незадача, у нас body каждого комментария одно и тоже, а именно <code class="highlighter-rouge">'Comment body'</code>.Что же делать и как нам быть? Раз уж мы договорились создать подобие “живого” приложения, то и комментарии у нас должны быть разные и тоже живые. Первое, что приходит в голову, - опять использовать массив данных, но я слишков ленив (да и не путь самурая это), чтобы все это набирать, пусть даже копипастить и тем более придумывать. Второе, что приходит на ум, генерировать рандомную строчку текста. Да, идея не плохая, как минимум, нам придется писать меньше кода, и он по-любому будет всегда разный. Но есть одно но: мы пытаемся достигнуть абсолютной правдоподобности, а строки вида <code class="highlighter-rouge">'skjafnskdjn ksajdnf'</code> нам точно не подойдут как комментарии. Поэтому нам на помощь приходит отличное решение - гем <a href="https://github.com/postmodern/raingrams">raingrams</a>.</p>

<p>Что же такого может этот гем, спросите Вы? На самом деле, ничего особенного, Вы просто скармливаете ему текст, а он, в свою очередь, разбивает его на куски и рандомно выдает обратно. В чем плюсы? Да, они не отличаются от банальной генерации строки, единственное и очевидное отличие - генерируемый текст будет логичен в пределах строки.</p>

<p>В документации достаточно подробно описано, как гем ставится и настраивается, но я бы хотел уделить внимание 2ум подводным камням, с которыми мы столкнулись:</p>

<ul>
  <li>
    <p>Во первых, гем не поддерживает русский язык. Скажем так, он его не видит. Поэтому, если для Вас важен русский язык, используйте наш <a href="https://github.com/dointeractive/raingrams">форк</a>, в котором исправлен этот косяк.</p>
  </li>
  <li>
    <p>Ну а второй момент, в старых версиях существовал метод <code class="highlighter-rouge">train_with_url</code>, в который передавалась ссылка, а он уже все парсил и выдавал конечный результат. К сожалению, в свежих версиях этот метод был убран, причем убран очень хитро. Если быть точным, то автор просто вырезал часть этого метода, а вторую забыл(а может, решил стебануться над простыми парнями как мы, этого я, к сожалению, не знаю :) ).</p>
  </li>
</ul>

<p>А теперь, используя полученные знания, перепишем наш метод. В качестве текста для raingrams мы будем использовать комментарии из пикабу, которые предварительно распарсим:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">model</span> <span class="o">=</span> <span class="no">QuadgramModel</span><span class="p">.</span><span class="nf">build</span> <span class="k">do</span> <span class="o">|</span><span class="n">model</span><span class="o">|</span>
  <span class="n">doc</span> <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">HTML</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">'http://pikabu.ru/story/v_den_programmista_pro_logiku_pikabu_685289'</span><span class="p">))</span>
  <span class="n">doc</span><span class="p">.</span><span class="nf">search</span><span class="p">(</span><span class="s1">'div.comment_desc'</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">div</span><span class="o">|</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">train_with_text</span><span class="p">(</span><span class="n">div</span><span class="p">.</span><span class="nf">inner_text</span><span class="p">)</span>
    <span class="n">model</span><span class="p">.</span><span class="nf">refresh</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># ....</span>

<span class="n">posts</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span>
  <span class="n">rand_user</span> <span class="o">=</span> <span class="n">rnd_user</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rnd</span>

  <span class="n">post</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand_user</span><span class="p">.</span><span class="nf">id</span>
  <span class="n">created_post</span> <span class="o">=</span> <span class="n">rand_user</span><span class="p">.</span><span class="nf">create_post</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>

  <span class="n">rnd</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="mi">10</span><span class="o">..</span><span class="mi">21</span><span class="p">).</span><span class="nf">times</span> <span class="k">do</span>
    <span class="n">rand_user</span> <span class="o">=</span> <span class="n">rnd_user</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rnd</span>
    <span class="n">comment</span> <span class="o">=</span> <span class="n">created_post</span><span class="p">.</span><span class="nf">build_comment</span><span class="p">(</span><span class="n">rand_user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="nf">random_sentence</span><span class="p">)</span>
    <span class="n">comment</span><span class="p">.</span><span class="nf">save!</span>

    <span class="n">rnd</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="mi">9</span><span class="p">).</span><span class="nf">times</span> <span class="k">do</span>
      <span class="n">rand_user</span> <span class="o">=</span> <span class="n">rnd_user</span> <span class="n">user_count</span><span class="p">,</span> <span class="n">rnd</span>
      <span class="n">child_comment</span> <span class="o">=</span> <span class="n">created_post</span><span class="p">.</span><span class="nf">build_comment</span><span class="p">(</span><span class="n">rand_user</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="nf">random_sentence</span><span class="p">)</span>
      <span class="n">child_comment</span><span class="p">.</span><span class="nf">save!</span>
      <span class="n">child_comment</span><span class="p">.</span><span class="nf">move_to_child_of</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Кстати, я уверен, что немного изменив наш скрипт, можно будет создать подобную генератию текстов непосредственно для постов.</p>

<p>Выглядит здорово. Да, может, код не самый чистый, и в целом скрипт слишком часто обращается к базе, но согласитесь, наше творение имитирует реальную активность пользователей. Не идеально, конечно, но все же. Думаю, на этом можно было бы закончить рассказ, но остался последний момент, который хотелось бы осветить и исправить в нашем скрипте.</p>

<p>Как думаете, где еще нам придется создавать пользователей (и не только их), которых мы создали в самом начале? Правильно, в тестах, надо же на чем-то тестировать приложение. Так почему бы нам не убить 2ух зайцев и не заменить ручную генерацию, как это было в начале статьи, на старую добрую фабричную? Так как в нашем проекте мы используем гем  <a href="http://www.fabricationgem.org/">fabrication</a>, то и пример будет с ним. Вы также можете использовать любую другуюю фабрику, которая вам по вкусу.</p>

<p>Для начала определим нашего пользователя и администратора:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Fabricator</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">email</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Internet</span><span class="p">.</span><span class="nf">email</span>
  <span class="nb">name</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="p">.</span><span class="nf">name</span>
  <span class="n">password</span> <span class="s1">'12345678'</span>
  <span class="n">password_confirmation</span> <span class="s1">'12345678'</span>
<span class="k">end</span>

<span class="no">Fabricator</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">email</span> <span class="s1">'admin@my_app.org'</span>
  <span class="nb">name</span> <span class="s1">'admin'</span>
  <span class="n">password</span> <span class="s1">'12345678'</span>
  <span class="n">password_confirmation</span> <span class="s1">'12345678'</span>
<span class="k">end</span></code></pre></figure>

<p>Ну а теперь, воспользуемся нашей новосозданной фабрикой для избавления от лишнего кода в seed файле:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">user_count</span> <span class="o">=</span> <span class="n">rnd</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="mi">18</span><span class="o">..</span><span class="mi">23</span><span class="p">)</span>
<span class="no">Fabricate</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>

<span class="n">user_count</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">}</span></code></pre></figure>

<p>В итоге, мы смогли убрать достаточно приличный кусок cкрипта, избавшись от явного повтора кода.</p>

<p>На этом, пожалуй, я закончу наши эксперименты. Как видите, простора для фантазии осталось еще много и также осталось много идей для рефакторинга. В любом случае, данный пример явно показывает, что к любой, сколь скучной она не была бы, задаче всегда можно применить творческий подход и неплохо развлечься :)</p>


  <div class="tag-cloud post-tags">
    <ul>
    
      <li>
        <a href="/tags/#ruby"><span>ruby</span></a>
      </li>
    
      <li>
        <a href="/tags/#seed file"><span>seed file</span></a>
      </li>
    
      <li>
        <a href="/tags/#russian"><span>russian</span></a>
      </li>
    
    </ul>
  </div>
</div>

<div class="share_buttons">
  <div class='shareaholic-canvas' data-app='share_buttons' data-app-id='11548095'></div>
</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2020/05/19/five-common-issues-with-services-and-dry-monads/">
            Five common issues with services and dry-monads
            <small>19 May 2020</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2017/01/28/profiling-your-sql-queries-in-hanami-or-rom/">
            Profiling your SQL queries in hanami (or ROM)
            <small>28 Jan 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/11/23/ruby-tips-part-two/">
            Ruby tips #2
            <small>23 Nov 2016</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://fikysmyblog.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<script type="text/javascript">
//<![CDATA[
  (function() {
    var shr = document.createElement('script');
    shr.setAttribute('data-cfasync', 'false');
    shr.src = '//dsms0mj1bbhn4.cloudfront.net/assets/pub/shareaholic.js';
    shr.type = 'text/javascript'; shr.async = 'true';
    shr.onload = shr.onreadystatechange = function() {
      var rs = this.readyState;
      if (rs && rs != 'complete' && rs != 'loaded') return;
      var site_id = '9cc17325fe566a8d07d3ee25ce3fa991';
      try { Shareaholic.init(site_id); } catch (e) {}
    };
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(shr, s);
  })();
//]]>
</script>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
