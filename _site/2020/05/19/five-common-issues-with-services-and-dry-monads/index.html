<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Five common issues with services and dry-monads &middot; Anton Davydov
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/base.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- SEO -->
  
    <meta name="description" content="In this blogpost I try to explain how to avoid common problems which I saw in different projects" />
  

  <link rel="author" href="https://plus.google.com/u/0/104253015484296728880"/>
</head>


  <body>
    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>Personal page with my blog where I'll write about ruby, my ideas and technologies which I love<br><a href="https://twitter.com/anton_davydov" target="_blank">@anton_davydov</a></p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="http://davydovanton.com/contacts/">Contacts</a>
    <a class="sidebar-nav-item" href="http://davydovanton.com/tags/">All Posts</a>
    <a class="sidebar-nav-item" href="https://github.com/davydovanton">GitHub</a>
    <a class="sidebar-nav-item" href="https://twitter.com/anton_davydov">Twitter</a>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2021. All rights reserved.
    </p>
  </div>
</div>

    <div class="yandex_metrica">
<!-- Yandex.Metrika counter --><script type="text/javascript">var yaParams = {/*Здесь параметры визита*/};</script><script type="text/javascript">(function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter23652886 = new Ya.Metrika({id:23652886, webvisor:true, clickmap:true, trackLinks:true, accurateTrackBounce:true, trackHash:true,params:window.yaParams||{ }}); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks");</script><noscript><div><img src="//mc.yandex.ru/watch/23652886" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Anton Davydov</a>
            <small></small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Five common issues with services and dry-monads</h1>
  <span class="post-date">19 May 2020</span>
  <p>Today I found the source code of a simple test task in GitHub. The code author used dry-monads, services, and other abstractions. I found some issues in that code and recalled that I have seen the same issues in other projects. That’s why I think that it’s a common problem and it will be a good idea to make a review and explain how we can improve our code. Also, I expect that this blog post can be useful for “junior/middle” developers and it could be boring for “senior” developers.</p>

<p><strong>Important</strong></p>

<p>This blog post based only on my personal experience and I don’t want to write the “best” code in the world. The main point which I want to provide - share my knowledge and experience for everyone else. Also, I don’t want to say that you need to use services or dry-monads. But if you use it you can potentially face issues that I tried to describe in this blog post.</p>

<p>I asked the code author about this publication and he allowed me to do it.</p>

<h2 id="tldr">TLDR</h2>

<p>Problems:</p>

<ul>
  <li><a href="#naming-based-on-implementation">Naming based on implementation</a>;</li>
  <li><a href="#redundancy-of-service-objects">Redundancy of service objects</a>;</li>
  <li><a href="#using-of-generic-names">Using of generic names</a>;</li>
  <li><a href="#state-inside-a-class-and-mix-of-parameters-and-dependencie">State inside a class and mix of parameters and dependencie</a>;</li>
  <li><a href="#activemodels-chain-of-calls-in-business-logic">ActiveModel’s chain of calls in business logic</a>;</li>
</ul>

<p><a href="#finnal-result">Finnal result</a></p>

<h2 id="original-code">Original code</h2>

<p>The main operation (service) which we call from rails controller looks like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Groups</span>
  <span class="k">module</span> <span class="nn">Services</span>
    <span class="k">class</span> <span class="nc">JoinUser</span> <span class="o">&lt;</span> <span class="no">Service</span>
      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="ss">record: </span><span class="p">,</span>
        <span class="ss">input_validator: </span><span class="no">Users</span><span class="o">::</span><span class="no">Validators</span><span class="o">::</span><span class="no">NewUser</span><span class="p">.</span><span class="nf">new</span><span class="p">,</span>
        <span class="ss">user_exists_check: </span><span class="no">Users</span><span class="o">::</span><span class="no">Services</span><span class="o">::</span><span class="no">CheckExists</span><span class="p">,</span>
        <span class="ss">user_creator: </span><span class="no">Users</span><span class="o">::</span><span class="no">Services</span><span class="o">::</span><span class="no">Create</span>
      <span class="p">)</span>
        <span class="vi">@params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="vi">@input_validator</span> <span class="o">=</span> <span class="n">input_validator</span>
        <span class="vi">@record</span> <span class="o">=</span> <span class="n">record</span>
        <span class="vi">@user_creator</span> <span class="o">=</span> <span class="n">user_creator</span>
        <span class="vi">@user_exists_check</span> <span class="o">=</span> <span class="n">user_exists_check</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">call</span>
        <span class="n">validated_params</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">input_validate</span>
        <span class="k">yield</span> <span class="n">business_validate</span><span class="p">(</span><span class="n">validated_params</span><span class="p">.</span><span class="nf">to_h</span><span class="p">)</span>
        <span class="n">save</span><span class="p">(</span><span class="n">validated_params</span><span class="p">.</span><span class="nf">to_h</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="kp">private</span>

      <span class="nb">attr_reader</span> <span class="ss">:params</span><span class="p">,</span> <span class="ss">:record</span><span class="p">,</span> <span class="ss">:input_validator</span><span class="p">,</span> <span class="ss">:user_creator</span><span class="p">,</span> <span class="ss">:user_exists_check</span>

      <span class="k">def</span> <span class="nf">input_validate</span>
        <span class="n">input_validator</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:group</span><span class="p">]).</span><span class="nf">to_monad</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">business_validate</span><span class="p">(</span><span class="n">validated_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="no">Failure</span><span class="p">(</span><span class="ss">:already_exists</span><span class="p">)</span> <span class="k">if</span> <span class="n">record</span><span class="p">.</span><span class="nf">users</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">validated_params</span><span class="p">).</span><span class="nf">exists?</span>
        <span class="no">Success</span><span class="p">()</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">validated_params</span><span class="p">)</span>
        <span class="n">user_check_result</span> <span class="o">=</span> <span class="n">user_exists_check</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">validated_params</span><span class="p">[</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">call</span>
        <span class="k">if</span> <span class="n">user_check_result</span> <span class="o">==</span> <span class="no">Success</span><span class="p">(</span><span class="ss">:user_not_exists</span><span class="p">)</span>
          <span class="n">user</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">user_creator</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">validated_params</span><span class="p">).</span><span class="nf">call</span>

          <span class="n">record</span><span class="p">.</span><span class="nf">users</span> <span class="o">&lt;&lt;</span> <span class="n">user</span>
          <span class="k">return</span> <span class="no">Success</span><span class="p">(</span><span class="ss">:created</span><span class="p">)</span>
        <span class="k">end</span>

        <span class="n">record</span><span class="p">.</span><span class="nf">users</span> <span class="o">&lt;&lt;</span> <span class="n">user_check_result</span><span class="p">.</span><span class="nf">value!</span>

        <span class="no">Success</span><span class="p">(</span><span class="ss">:created</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Also, we use two dependencies, which look like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Users</span>
  <span class="k">module</span> <span class="nn">Service</span>
    <span class="k">class</span> <span class="nc">CheckExists</span> <span class="o">&lt;</span> <span class="no">Service</span>
      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="ss">model: </span><span class="no">User</span><span class="p">)</span>
        <span class="vi">@email</span> <span class="o">=</span> <span class="n">email</span>
        <span class="vi">@model</span> <span class="o">=</span> <span class="n">model</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">call</span>
        <span class="k">return</span> <span class="no">Success</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">email: </span><span class="n">email</span><span class="p">))</span> <span class="k">if</span> <span class="n">model</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">email: </span><span class="n">email</span><span class="p">).</span><span class="nf">exists?</span>
        <span class="no">Success</span><span class="p">(</span><span class="ss">:user_not_exists</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="kp">private</span>

      <span class="nb">attr_reader</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:model</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Users</span>
  <span class="k">module</span> <span class="nn">Services</span>
    <span class="k">class</span> <span class="nc">Create</span> <span class="o">&lt;</span> <span class="no">Service</span>
      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
        <span class="ss">input_validator: </span><span class="no">Users</span><span class="o">::</span><span class="no">Validators</span><span class="o">::</span><span class="no">NewUser</span><span class="p">.</span><span class="nf">new</span><span class="p">,</span>
        <span class="ss">model: </span><span class="no">User</span>
      <span class="p">)</span>
        <span class="vi">@params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="vi">@input_validator</span> <span class="o">=</span> <span class="n">input_validator</span>
        <span class="vi">@model</span> <span class="o">=</span> <span class="n">model</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">call</span>
        <span class="k">yield</span> <span class="n">input_validate</span>
        <span class="n">save</span>
      <span class="k">end</span>

      <span class="kp">private</span>

      <span class="nb">attr_reader</span> <span class="ss">:params</span><span class="p">,</span> <span class="ss">:model</span><span class="p">,</span> <span class="ss">:input_validator</span>

      <span class="k">def</span> <span class="nf">input_validate</span>
        <span class="n">input_validator</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">params</span><span class="p">).</span><span class="nf">to_monad</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">save</span>
        <span class="no">Try</span><span class="p">()</span> <span class="p">{</span> <span class="n">model</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="problems">Problems</h2>

<p>After reading and understanding the original code I found five places which I want to describe:</p>

<ul>
  <li><a href="#naming-based-on-implementation">Naming based on implementation</a>;</li>
  <li><a href="#redundancy-of-service-objects">Redundancy of service objects</a>;</li>
  <li><a href="#using-of-generic-names">Using of generic names</a>;</li>
  <li><a href="#state-inside-a-class-and-mix-of-parameters-and-dependencie">State inside a class and mix of parameters and dependencie</a>;</li>
  <li><a href="#activemodels-chain-of-calls-in-business-logic">ActiveModel’s chain of calls in business logic</a>;</li>
</ul>

<p>Let’s discuss each part.</p>

<h3 id="naming-based-on-the-implementation">Naming based on the implementation</h3>

<p>I think a good starting point for refactoring this code is to remove “out of context” words from variables, objects, and services names.</p>

<p>Quick example: you can see <code class="highlighter-rouge">save(validated_params.to_h)</code> (<code class="highlighter-rouge">Groups::Services::JoinUser</code> service) line in the original code. After some research, I realized that the original context is enrolling users in groups. I mean that from the implementation perspective this line should update something in DB. But from business logic, the service has an absolutely different context. That’s why I think that <code class="highlighter-rouge">#enroll</code> will be better than <code class="highlighter-rouge">#save</code> here.</p>

<p>If you want to use implementation details in naming you should be ready to spend more time understanding the context of each method/service and thinking why we have this code here. But if you use naming based on business flow you provide a context that can answer the question “why?” and you can reduce time spent on understanding the source code. I think that domain-driven design (DDD in the future) is trying to give the same idea related to naming, that’s why if you want to read more about it - DDD books will be a good start (and event storming for understanding better all business events in the system).</p>

<h3 id="redundancy-of-service-objects">Redundancy of service objects</h3>

<p>I can see two global issues in the original source code:</p>
<ol>
  <li>The main service depend on a lot of different dependencies (like <code class="highlighter-rouge">Users::Validators::NewUser.new</code>, <code class="highlighter-rouge">Users::Services::CheckExists</code>, <code class="highlighter-rouge">Users::Services::Create</code> and direct model calls like <code class="highlighter-rouge">record.users.where(validated_params).exists?</code>);</li>
  <li>Both called services implements only DB logic (checking for the existence of the record and saving data in DB);</li>
</ol>

<p>Let’s start with DB request logic. It’s a  great temptation is to make 2 separate services and put DB logic there, like the author of the original example did. I can understand it because you want to isolate parts of your service. But this way has a downside - your business logic looks complicated. For example, let’s check two lines in <code class="highlighter-rouge">Groups::Services::JoinUser#save</code> method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">validated_params</span><span class="p">)</span>
  <span class="n">user_check_result</span> <span class="o">=</span> <span class="n">user_exists_check</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">validated_params</span><span class="p">[</span><span class="ss">:email</span><span class="p">]).</span><span class="nf">call</span>
  <span class="c1"># We need to execute strange comparation logic with Result monad here</span>
  <span class="c1"># </span>
  <span class="c1"># The logic is strange because the monad looks strange in current context. It's complicated to say why `user_not_found` is a success result.</span>
  <span class="c1"># We need bussines logic knowledge to say why it is</span>
  <span class="k">if</span> <span class="n">user_check_result</span> <span class="o">==</span> <span class="no">Success</span><span class="p">(</span><span class="ss">:user_not_exists</span><span class="p">)</span>

    <span class="c1"># We need to use DO notations in the nested method in the current case.</span>
    <span class="c1"># That's why we'll get nesting and it can be possible to increase the complication of understanding the data flow in the system</span>
    <span class="n">user</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">user_creator</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">validated_params</span><span class="p">).</span><span class="nf">call</span>
</code></pre></div></div>

<p>I can see that the author wrapped up the database operation into nested DO notation (which not important in this case) and thus inflated his own code. That’s why it looks like those same methods should be in model/repository (if you use repository pattern). Also, we come to the context issue based on the naming of methods, because the service names describe implementation details instead of business steps/logic.</p>

<h3 id="using-of-generic-names">Using of generic names</h3>

<p>You can find a lot of base words in the example like <code class="highlighter-rouge">record</code>, <code class="highlighter-rouge">user_exists_check</code>, <code class="highlighter-rouge">validated_params</code>, <code class="highlighter-rouge">business_validate</code>, <code class="highlighter-rouge">input_validate</code>, <code class="highlighter-rouge">params</code> and others. I covered it in the first issue. It’s really hard to understand what these objects/methods do and why we need it without a full context of logic.</p>

<p>For example, read naming for two services and try to answer what each service do here:</p>

<ul>
  <li><code class="highlighter-rouge">Groups::Services::JoinUser</code></li>
  <li><code class="highlighter-rouge">Groups::Services::EnrollUser</code></li>
</ul>

<p>When I see <code class="highlighter-rouge">JoinUser</code> I expect that we take a user from data storage and just join them to a group. But in real world we need to enroll a user to a specific group.</p>

<h3 id="state-inside-a-class-and-mix-of-parameters-and-dependencie">State inside a class and mix of parameters and dependencie</h3>

<p>In the original example, the author used dependency injection (DI in the future) for calling other services and validations. It’s a powerful technique with helps with testing and paintability of your project (I suggest to check posts or talks from <a href="https://twitter.com/_solnic_">solnic</a>, <a href="https://twitter.com/timriley">Tim</a>, and <a href="https://twitter.com/jodosha">Luca</a> if you don’t use or see it before).</p>

<p>As you can see the author puts data and dependencies inside the class constructor (<code class="highlighter-rouge">#initialize</code>) in each service.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">record</span><span class="p">:,</span> <span class="c1"># data</span>
  <span class="ss">input_validator: </span><span class="no">Users</span><span class="o">::</span><span class="no">Validators</span><span class="o">::</span><span class="no">NewUserContract</span><span class="p">.</span><span class="nf">new</span><span class="p">,</span> <span class="c1"># dependency</span>
  <span class="ss">user_exists_check: </span><span class="no">Users</span><span class="o">::</span><span class="no">Services</span><span class="o">::</span><span class="no">CheckExists</span><span class="p">,</span> <span class="c1"># dependency</span>
  <span class="ss">user_creator: </span><span class="no">Users</span><span class="o">::</span><span class="no">Services</span><span class="o">::</span><span class="no">Create</span> <span class="c1"># dependency</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="ss">model: </span><span class="no">User</span><span class="p">)</span>
  <span class="vi">@email</span> <span class="o">=</span> <span class="n">email</span>  <span class="c1"># data</span>
  <span class="vi">@model</span> <span class="o">=</span> <span class="n">model</span> <span class="c1"># dependency</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="c1"># data</span>
  <span class="ss">input_validator: </span><span class="no">Users</span><span class="o">::</span><span class="no">Validators</span><span class="o">::</span><span class="no">NewUserContract</span><span class="p">.</span><span class="nf">new</span><span class="p">,</span> <span class="c1"># dependency</span>
  <span class="ss">model: </span><span class="no">User</span> <span class="c1"># dependency</span>
<span class="p">)</span>
</code></pre></div></div>

<p>It’s not a problem in general. But if you use complicated dependencies with long time building (for example rom) or want to use DI in testing you’ll get a problem. Also, you’ll allocate new objects every action calls, but it’s not a critical.</p>

<p>The most critical part of this code states inside a class because you get two issues:</p>

<p>You’re losing pure objects conception. It means that you can possibly get bugs related to mutation of your state.</p>

<p>This solution is increasing maintainability of the code. For example, check these two methods from the service object:</p>

<ul>
  <li><code class="highlighter-rouge">def save(validated_params)</code></li>
  <li><code class="highlighter-rouge">def save(record, validated_params)</code></li>
</ul>

<p>In the first method, we see <code class="highlighter-rouge">save</code> method plus <code class="highlighter-rouge">validated_params</code>. Based on this knowledge I can say that the method just store something in the base and that’s all. In the second method, we see that method saves something related to the <code class="highlighter-rouge">record</code>. The problem here in that method really uses <code class="highlighter-rouge">record</code> data based on the state of the service inside self but we can’t understand it without reading the code.</p>

<h3 id="activemodels-chain-of-calls-in-business-logic">ActiveModel’s chain of calls in business logic</h3>

<p>I didn’t use rails last 3 years but I can understand that It’s a common approach in rails. I’m talking about lines with <code class="highlighter-rouge">record.users.where(payload).exists?</code> or something like this. I see two problems in this approach:</p>

<ol>
  <li>It’s hard to use unit tests for this because you need to mock a chain of methods. It’s not a problem if you’re using only integration testing but integration testing increases time for your test suite because you use DB calls every time.</li>
  <li>The issue connected to the first point, you need to make transformation AR DSL to a specific context. For example, say what is better to understand <code class="highlighter-rouge">record.users.where(payload).exists?</code> or <code class="highlighter-rouge">record.attendee?(payload)</code>.</li>
</ol>

<h2 id="finnal-result">Finnal result</h2>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Cource</span>
  <span class="k">module</span> <span class="nn">Services</span>
    <span class="k">class</span> <span class="nc">EnrollUser</span> <span class="o">&lt;</span> <span class="no">Core</span><span class="o">::</span><span class="no">Service</span>
      <span class="nb">attr_reader</span> <span class="ss">:model</span><span class="p">,</span> <span class="ss">:validator</span>

      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="ss">model: </span><span class="no">User</span><span class="p">,</span> <span class="ss">validator: </span><span class="no">Users</span><span class="o">::</span><span class="no">Validators</span><span class="o">::</span><span class="no">NewUserContract</span><span class="p">.</span><span class="nf">new</span><span class="p">)</span>
        <span class="vi">@model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="vi">@validator</span> <span class="o">=</span> <span class="n">validator</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">validate_raw_data</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">group_attendee?</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>

        <span class="n">user</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">find_or_create_by_email</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="ss">:email</span><span class="p">])</span>

        <span class="n">success</span><span class="p">(</span><span class="n">group</span><span class="p">.</span><span class="nf">enroll</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
      <span class="k">end</span>

    <span class="kp">private</span>

      <span class="k">def</span> <span class="nf">validate_raw_data</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="c1"># don't forget to enable monads extention</span>
        <span class="c1">#   Dry::Validation.load_extensions(:monads)</span>
        <span class="c1">#</span>
        <span class="c1"># https://dry-rb.org/gems/dry-validation/master/extensions/</span>
        <span class="n">validator</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">payload</span><span class="p">).</span><span class="nf">to_either</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">group_attendee?</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
        <span class="n">group</span><span class="p">.</span><span class="nf">attendee?</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="p">?</span> <span class="n">failure</span><span class="p">(:</span><span class="n">group_attendee</span><span class="p">)</span> <span class="p">:</span> <span class="n">success</span><span class="p">()</span>
      <span class="k">end</span>

      <span class="k">def</span> <span class="nf">find_or_create_by_email</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="no">Try</span><span class="p">()</span> <span class="p">{</span> <span class="n">model</span><span class="p">.</span><span class="nf">find_or_create</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="p">}.</span><span class="nf">to_result</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Group</span>
  <span class="k">def</span> <span class="nf">attendee?</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">users</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">payload</span><span class="p">).</span><span class="nf">exists?</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">enroll</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">users</span> <span class="o">&lt;&lt;</span> <span class="n">user</span>
    <span class="nb">self</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">User</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">find_or_create</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="n">find_by_email</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="ss">:email</span><span class="p">])</span> <span class="o">||</span> <span class="n">create!</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You can see that I got a different code based on issues which I tried to describe on the top. In this code you can see business steps that you need to do to make something happen (<code class="highlighter-rouge">validation -&gt; user verification for specific source group -&gt; enrolling user</code>). Also, I dropped unnecessary services and move logic to models with context related names.</p>

<p>This code is not great, also, different developers will use different ways to write this logic and I’m not sure that “true” way exists here. But if you compare services you see that sometimes a better name is more than separate service and one more abstraction.</p>

<p>Also, you will get a code that can be covered by unit tests without any pain. For example, you can test business logic in <code class="highlighter-rouge">#group_attendee?</code> without any integration tests and complicated preparation of the data:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Cource</span><span class="o">::</span><span class="no">Services</span><span class="o">::</span><span class="no">EnrollUser</span><span class="p">,</span> <span class="ss">type: :service</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="n">service</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="ss">group: </span><span class="n">group</span><span class="p">,</span> <span class="ss">params: </span><span class="n">params</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:service</span><span class="p">)</span> <span class="p">{</span> <span class="n">described_class</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">model: </span><span class="n">model</span><span class="p">,</span> <span class="ss">validator: </span><span class="n">validator</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">let</span><span class="p">(</span><span class="ss">:model</span><span class="p">)</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:validator</span><span class="p">)</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>

  <span class="n">context</span> <span class="s1">'when user is an attendee for a group'</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:group</span><span class="p">)</span> <span class="p">{</span> <span class="n">instance_double</span><span class="p">(</span><span class="s1">'Group'</span><span class="p">,</span> <span class="ss">attendee?: </span><span class="kp">true</span><span class="p">)</span> <span class="p">}</span>

    <span class="c1"># your tests for one case of logic</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s1">'when user is not an attendee for a group'</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:group</span><span class="p">)</span> <span class="p">{</span> <span class="n">instance_double</span><span class="p">(</span><span class="s1">'Group'</span><span class="p">,</span> <span class="ss">attendee?: </span><span class="kp">false</span><span class="p">)</span> <span class="p">}</span>

    <span class="c1"># your tests for other case of logic</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s1">'test case with real dependencies for test everythign together'</span> <span class="k">do</span>
    <span class="n">subject</span> <span class="p">{</span> <span class="n">service</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:service</span><span class="p">)</span> <span class="p">{</span> <span class="n">described_class</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>

    <span class="c1"># some data preporation</span>

    <span class="n">it</span> <span class="p">{</span> <span class="n">expect</span><span class="p">(</span><span class="n">subject</span><span class="p">).</span><span class="nf">to</span> <span class="n">be_success</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<ul>
  <li><em>Note to testing part: I’m thinking that you should use the unit and integration testing for full coverage. In my example, I’ll also add 1+ integration test for test all contracts between dependencies to be sure that everything is okay with real code and data.</em></li>
</ul>

<h2 id="conclusions">Conclusions</h2>

<ul>
  <li>Use context instead of implementation in your code. Context is really important from a maintainability perspective and your colleagues and you from the future say “thank you”. Also, you can skip unnecessary questions on PR/MR review process and make it faster;</li>
  <li>Using a good naming is extremely hard. I spent more than 3 years to start writing something understandable for other developers. I can suggest some rules which help me every day;
    <ul>
      <li>Imagine a real world process. For example in the original example try to imagine how this logic should work from a user perspective. Forget about CRUD or SQL implementation. Just write real steps on how a user can do something. In my case, I wrote, “as a user if I have valid data in my form or profile AND if I didn’t attend this course group I can attend”. Based on these words I found important steps and used this note for creating names for my methods/services;</li>
      <li>If you want to use common words like <code class="highlighter-rouge">user_exists_check</code>, <code class="highlighter-rouge">input_validate</code>, etc. make a pause and ask yourself what you want to explain from real world perspective;</li>
      <li>This approach takes some time and can be difficult. But it can be good practice for improving your skills as a developer. And knowing a domain can be useful in the future to understand tasks or communicate with colleagues better;</li>
    </ul>
  </li>
  <li>Sometimes is better to use models for DB logic instead of creating a new service object with common behavior;</li>
  <li>It’s a good idea to split data and dependencies for each service object. In this case, you can avoid unnecessary allocation, cache some initializations and drop mutable state inside objects;</li>
  <li>Using model methods instead of a chain of DSL methods can be profitable from two perspectives: adding a good name for each DB request instead of a “pure” SQL and simplify unit testing and avoiding mocking chain of methods;</li>
</ul>

<h2 id="useful-links">Useful links</h2>

<ul>
  <li><a href="https://dry-rb.org/gems/dry-monads/1.3">dry-monads and DO notations guide</a> - if you never work with it and don’t know how it works;</li>
  <li><a href="https://www.lucidchart.com/blog/ddd-event-storming">Event storming</a> - you can try to adopt this idea to get more context and information about your system;</li>
  <li><a href="https://www.youtube.com/watch?v=B26rbJfRoZo">Tim’s talk</a> where he described dry-rb ideas and services with separated data and dependencies;</li>
</ul>

<h2 id="upd">UPD</h2>

<ol>
  <li>Added <code class="highlighter-rouge">validate_raw_data</code> method. Thanks mpak for mention it (from comments)</li>
</ol>


  <div class="tag-cloud post-tags">
    <ul>
    
      <li>
        <a href="/tags/#ruby"><span>ruby</span></a>
      </li>
    
      <li>
        <a href="/tags/#services"><span>services</span></a>
      </li>
    
      <li>
        <a href="/tags/#thoughts"><span>thoughts</span></a>
      </li>
    
      <li>
        <a href="/tags/#refactoring"><span>refactoring</span></a>
      </li>
    
    </ul>
  </div>
</div>

<div class="share_buttons">
  <div class='shareaholic-canvas' data-app='share_buttons' data-app-id='11548095'></div>
</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2017/01/28/profiling-your-sql-queries-in-hanami-or-rom/">
            Profiling your SQL queries in hanami (or ROM)
            <small>28 Jan 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/11/23/ruby-tips-part-two/">
            Ruby tips #2
            <small>23 Nov 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/11/16/ruby-tips-part-one/">
            Ruby tips #1
            <small>16 Nov 2016</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://fikysmyblog.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<script type="text/javascript">
//<![CDATA[
  (function() {
    var shr = document.createElement('script');
    shr.setAttribute('data-cfasync', 'false');
    shr.src = '//dsms0mj1bbhn4.cloudfront.net/assets/pub/shareaholic.js';
    shr.type = 'text/javascript'; shr.async = 'true';
    shr.onload = shr.onreadystatechange = function() {
      var rs = this.readyState;
      if (rs && rs != 'complete' && rs != 'loaded') return;
      var site_id = '9cc17325fe566a8d07d3ee25ce3fa991';
      try { Shareaholic.init(site_id); } catch (e) {}
    };
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(shr, s);
  })();
//]]>
</script>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
